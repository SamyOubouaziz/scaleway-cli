
name: build and push doc to S3
on:
  pull_request:
  push:
    branches:
      - master 
      - main
permissions:
  contents: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: actions
    steps:
      - uses: actions/checkout@v4
      - name: Configure Git Credentials # stolen from material for MKdocs action to push to GH pages
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - run: echo "cache_id=$(date --utc '+%V')" >> $GITHUB_ENV 
      - uses: actions/cache@v4
        with:
          key: mkdocs-material-${{ env.cache_id }}
          path: .cache
          restore-keys: |
            mkdocs-material-
      - run: pip install mkdocs-material 
      - run: cd docs && mkdocs build
      # - name: Install MinIO Client # works, but insufficient rights to copy to bucket
      #   run: |
      #     wget https://dl.min.io/client/mc/release/linux-amd64/mc
      #     chmod +x mc
      #     ./mc --help
      # - name: Create MinIO alias
      #   run: |
      #     ./mc alias set scws3 https://s3.nl-ams.scw.cloud ${{ secrets.AWS_ACCESS_KEY_ID }} ${{ secrets.AWS_SECRET_ACCESS_KEY }} --api S3v4
      # - name: Push to bucket
      #   run: |
      #     ./mc cp --recursive ./docs/site/ scws3/scaleway-cli-doc/
      # - run: rm -rf ./docs/site
      - name: Set up AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Upload file to S3-Compatible Storage
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID 
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set region nl-ams

          aws s3 cp --recursive ./docs/site/ s3://scaleway-cli-doc --endpoint-url https://s3.nl-ams.scw.cloud